<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Anime Journey</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { /* Using variables from your slimegame for consistency */
            --primary: #9b4d96; 
            --secondary: #f5a9bc; 
            --dark: #2a0a3a;
            --light: #fce4ec; 
            --accent: #e91e63; 
            --success: #4CAF50;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif; background-color: #f1a1c2; color: #333;
            min-height: 100vh; padding-left: 100px; padding-right: 100px;
            text-align: center; position: relative; overflow-x: hidden;
        }

        /* ===== NAVIGATION BARS (Copied from slimegame.html structure) ===== */
        .nav-container-left, .nav-container-right {
            position: fixed; top: 0; height: 100vh; width: 100px;
            background-color: var(--dark); display: flex; flex-direction: column;
            align-items: center; padding-top: 30px; z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .nav-container-left { left: 0; border-right: 3px solid var(--secondary); }
        .nav-container-right { right: 0; border-left: 3px solid var(--secondary); }

        .nav-item {
            width: 100%; text-align: center; padding: 15px 0; margin: 10px 0;
            color: white; font-size: 0.9em; text-decoration: none; transition: all 0.3s;
        }
        .nav-container-left .nav-item { border-radius: 0 8px 8px 0; }
        .nav-container-right .nav-item { border-radius: 8px 0 0 8px; }

        .nav-item:hover { background-color: var(--primary); }
        .nav-container-left .nav-item:hover { transform: translateX(5px); }
        .nav-container-right .nav-item:hover { transform: translateX(-5px); }
        .nav-item img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 8px; }
        .active { background-color: var(--accent); font-weight: bold; }

        /* ===== Page Wrapper & Header (from slimegame.html) ===== */
        .page-wrapper { 
            max-width: 1000px; margin: 0 auto; padding: 20px 0; position: relative;
        }
        header {
            background-color: var(--primary); color: white; padding: 20px; font-size: 2em;
            text-transform: uppercase; font-weight: bold; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative;
        }
        /* This will be the main content area holding the anime features */
        .main-content-area { 
            width: 100%; padding: 20px; background-color: white;
            border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 40px; position: relative;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Feature Wrapper (like slime-game-wrapper) */
        .feature-wrapper {
             display: flex;
             flex-direction: column;
             align-items: center;
             width: 100%;
             max-width: 600px; /* Adjust as needed for anime content */
             margin: 0 auto; 
        }
        
        /* Bows & Hearts (from slimegame.html) */
        .bow { position: absolute; width: 40px; height: 40px; background: url('https://i.imgur.com/tA7aPg4.png') center/contain no-repeat; z-index: 10; }
        .hearts-container { position: fixed; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; z-index: -1; overflow: hidden; }
        .heart { position: absolute; width: 30px; height: 30px; color: var(--secondary); font-size: 30px; opacity: 0.7; animation: floatUp 15s linear infinite; }
        @keyframes floatUp { 0% { transform: translateY(100vh) scale(0.5) rotate(0deg); opacity: 0; } 10% { opacity: 0.7; } 90% { opacity: 0.7; } 100% { transform: translateY(-20vh) scale(1.2) rotate(360deg); opacity: 0; } }
        .header-bow-left { top: -15px; left: -15px; } .header-bow-right { top: -15px; right: -15px; }
        .main-bow-tl { top: -15px; left: -15px; } .main-bow-tr { top: -15px; right: -15px; }
        .main-bow-bl { bottom: -15px; left: -15px; } .main-bow-br { bottom: -15px; right: -15px; }


        /* --- ANIME PAGE SPECIFIC STYLES --- */
        .anime-page-title { /* For "Sui's Anime Roulette!" */
            font-family: 'Pacifico', cursive;
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .anime-intro-text {
            margin-bottom: 25px;
            font-size: 1rem;
            color: #555;
        }

        .sui-animation-container {
            width: 150px; /* Adjust size */
            height: 120px;
            position: relative;
            margin-bottom: 20px;
        }
        .sui-body-img { width: 100%; height: auto; display: block; position: relative; z-index: 1; animation: body-jiggle 3s infinite ease-in-out; }
        .sui-arm-img {
            position: absolute; width: 40px; height: auto;
            top: 55%; left: 72%; /* YOU WILL LIKELY NEED TO TWEAK THESE */
            transform: translateY(-50%); z-index: 2;
            transform-origin: 10% 90%; /* CRUCIAL PIVOT POINT - TWEAK THIS */
            animation: wave-arm 1.3s infinite ease-in-out alternate;
        }
        @keyframes wave-arm { 0% { transform: translateY(-50%) rotate(-20deg); } 100% { transform: translateY(-50%) rotate(15deg); } }
        @keyframes body-jiggle { 0%,100% {transform:scale(1,1) translateY(0);} 25% {transform:scale(1.03,0.97) translateY(1px);} 50% {transform:scale(0.97,1.03) translateY(-1px);} 75% {transform:scale(1.02,0.98) translateY(0.5px);} }

        .wheel-section { margin-bottom: 20px; width: 100%; display: flex; flex-direction: column; align-items: center;}
        .wheel-mode-selector { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .wheel-mode-btn {
            background: var(--secondary); color: white; border: none; padding: 8px 18px;
            font-size: 0.9em; border-radius: 20px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .wheel-mode-btn.active { background: var(--primary); font-weight: 600; }
        .wheel-mode-btn:hover:not(.active) { background-color: #e67fa1; }

        #wheelContainer { position: relative; width: 300px; height: 300px; cursor: pointer; margin-bottom:15px;}
        #interactiveWheelCanvas { display: block; border-radius: 50%; box-shadow: 0 0 12px rgba(0,0,0,0.15); width:100%; height:100%;}
        #wheelPointer {
            position: absolute; top: 50%; left: calc(100% - 8px); transform: translateY(-50%) translateX(-100%); 
            width: 0; height: 0; border-left: 18px solid var(--accent); 
            border-top: 10px solid transparent; border-bottom: 10px solid transparent;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.2)); z-index: 5;
        }
        #spinWheelBtn {
            background: linear-gradient(135deg, var(--primary), #7c3c79); color: white; border: none;
            padding: 10px 25px; font-size: 1em; border-radius: 50px; cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15); transition: all 0.3s ease; margin-bottom: 15px;
        }
        #spinWheelBtn:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
        #spinWheelBtn:disabled { background: #ccc; cursor: not-allowed; }
        #wheelResult {
            font-size: 1.3em; font-weight: bold; color: var(--accent);
            padding: 8px 12px; background-color: var(--light); border-radius: 8px;
            min-height: 40px; display: flex; align-items: center; justify-content: center;
            width: 100%; max-width: 300px; text-align: center; margin-bottom: 10px;
        }
        #challengeDescriptionDisplay, #suiCommentDisplay { 
            padding: 8px; border-radius: 5px; display:none; font-size: 0.9em;
            width: 100%; max-width: 300px; text-align: left; margin-bottom: 5px;
        }
        #challengeDescriptionDisplay { background-color: #fff8e1; border-left: 3px solid #ffb74d; }
        #suiCommentDisplay { background-color: #e3f2fd; border-left: 3px solid #64b5f6; font-style: italic; }

        .add-content-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; margin-bottom: 10px; flex-wrap: wrap;}
        .admin-action-btn { /* Using a more generic name as it's for adding content */
            background: linear-gradient(135deg, #6a4d9b, #4d7c9b); color: white; border: none;
            padding: 10px 20px; font-size: 0.95em; border-radius: 8px; cursor: pointer;
            transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px;
        }
        .admin-action-btn:hover { transform: translateY(-2px); box-shadow: 0 3px 7px rgba(0,0,0,0.15); }
        .admin-action-btn i { margin-right: 5px; }

        /* Modal Styles (consistent with bookdate.html) */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding:15px; }
        .modal-content { background-color: #fff; margin: auto; padding: 25px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 90%; max-width: 550px; position: relative; animation: modalopen 0.3s ease-out; }
        @keyframes modalopen { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content h3 { font-family: 'Pacifico', cursive; color: var(--primary); margin-bottom: 20px; text-align: center;}
        .close-modal-btn { color: #aaa; position:absolute; top:10px; right:15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal-btn:hover, .close-modal-btn:focus { color: var(--dark); text-decoration: none; }
        .admin-form .form-group { margin-bottom: 15px; text-align: left; } /* Re-using admin-form class name for modal forms */
        .admin-form label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--dark); font-size: 0.9em;}
        .admin-form input[type="text"], .admin-form input[type="url"], .admin-form textarea, .admin-form select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95em; }
        .admin-form textarea { min-height: 80px; resize: vertical; }
        .form-buttons { text-align: right; margin-top: 20px; }
        .form-buttons button { padding: 10px 20px; color:white; }
        .form-buttons button[type="submit"] { background-color: var(--success); }
        .form-buttons button[type="button"] { background-color: var(--secondary); color: var(--dark); }

        .loading-indicator { text-align: center; font-style: italic; color: var(--primary); padding: 10px; font-size: 0.9em; }
        
        @media (max-width: 768px) {
            body { padding-left: 0; padding-right: 0; padding-bottom: 80px; }
            .nav-container-left, .nav-container-right { width: 100%; height: 80px; flex-direction: row; padding-top: 0; bottom: 0; top: auto; border-right: none; border-left: none; border-top: 3px solid var(--secondary); justify-content: space-around; }
            .nav-container-right { display: none; } 
            .nav-container-left .nav-item { flex-grow: 1; border-radius: 0; margin: 0; }
            .nav-container-left .nav-item:hover { transform: none; }
            .nav-item { padding: 10px 0; font-size: 0; margin: 0; }
            .nav-item img { width: 30px; height: 30px; margin-bottom: 0; }
            .page-wrapper { padding: 10px; } .container { padding: 15px; }
            h1 { font-size: 1.8rem; }
            .sui-animation-container { width: 120px; height: 100px; }
            .sui-arm-img { width: 35px; top: 50%; left: 68%; }
            #wheelContainer { width: 250px; height: 250px; } 
            .wheel-mode-selector { flex-direction: column; gap: 8px; }
            .wheel-mode-btn { width: 70%; margin: 0 auto; font-size: 0.85em; padding: 8px 15px;}
            .add-content-buttons { flex-direction: column; gap: 10px; }
            .admin-action-btn { width: 70%; margin: 0 auto; font-size: 0.9em; padding: 8px 18px;}
            .bow {display:none;}
        }
         @media (max-width: 480px) {
            .page-wrapper { padding: 5px;} .container {padding:10px;}
            h1 { font-size: 1.6rem; }
            .sui-animation-container { width: 100px; height: 80px; }
            .sui-arm-img { width: 30px; top: 50%; left: 65%; }
            #wheelContainer { width: 200px; height: 200px; }
            #wheelResult { font-size: 1.1em; }
            .modal-content { padding: 15px; }
            .modal-content h3 { font-size: 1.3rem; }
            .admin-form input, .admin-form textarea, .admin-form select { padding: 8px; font-size: 0.9rem; }
         }
    </style>
</head>
<body>
    <!-- Left Navigation -->
    <div class="nav-container-left">
        <a href="index.html" class="nav-item home"> <img src="https://i.imgur.com/ZAl2gbp.png" alt="Home"> Home </a>
        <a href="loveletters.html" class="nav-item letters"> <img src="https://i.imgur.com/ZVhcvD8.png" alt="Love Letters"> Love Letters </a>
        <a href="lovecalculator.html" class="nav-item calculator"> <img src="https://i.imgur.com/megzmKr.png" alt="Love Calculator"> Love Calculator </a>
        <a href="movies.html" class="nav-item movies"> <img src="https://i.imgur.com/gzW8uSH.png" alt="Movie Picker"> Movie Picker </a>
        <a href="bookdate.html" class="nav-item bookdate"> <img src="https://i.imgur.com/megzmKr.png" alt="Book a Date"> Book a Date </a>
        <a href="timezone.html" class="nav-item timezone"> <img src="https://i.imgur.com/ZwOw9QN.png" alt="Time Bridge"> Time Bridge </a>
    </div>

    <!-- Main Content -->
    <div class="page-wrapper">
        <header>
            Our Anime Journey ðŸŒ¸ <!-- Page Title -->
            <img src="https://i.imgur.com/tA7aPg4.png" class="bow header-bow-left">
            <img src="https://i.imgur.com/tA7aPg4.png" class="bow header-bow-right">
        </header>

        <div class="main-content-area"> <!-- Main content area like slimegame.html -->
            <img src="https://i.imgur.com/tA7aPg4.png" class="bow main-bow-tl">
            <img src="https://i.imgur.com/tA7aPg4.png" class="bow main-bow-tr">
            <img src="https://i.imgur.com/tA7aPg4.png" class="bow main-bow-bl">
            <img src="https://i.imgur.com/tA7aPg4.png" class="bow main-bow-br">
            
            <div class="feature-wrapper"> <!-- Wrapper for anime features -->
                <h1 class="anime-page-title">Sui's Anime Roulette!</h1>
                <p class="anime-intro-text">Let Sui help us pick our next anime adventure or a fun challenge!</p>

                <div class="anime-interactive-section">
                    <div class="sui-animation-container">
                        <img src="https://i.imgur.com/sYAd5HD.png" alt="Sui the Slime" class="sui-body-img">
                        <img src="https://i.imgur.com/iuAY7a2.png" alt="Sui's Waving Arm" class="sui-arm-img">
                    </div>

                    <div class="wheel-controls-container">
                        <div id="wheelContainer">
                            <canvas id="interactiveWheelCanvas" width="300" height="300"></canvas>
                            <div id="wheelPointer"></div>
                        </div>
                        <button id="spinWheelBtn" disabled>Spin for a <span id="spinBtnText">Challenge</span>!</button>
                        <div id="wheelResult">Loading data...</div>
                        <div id="challengeDescriptionDisplay"></div>
                        <div id="suiCommentDisplay"></div>
                    </div>
                </div>
                
                <div class="wheel-mode-selector">
                    <button id="challengeModeBtn" class="wheel-mode-btn active">Challenge Roulette</button>
                    <button id="seriesModeBtn" class="wheel-mode-btn">Anime Series Roulette</button>
                </div>
                
                <div class="add-content-buttons">
                    <button id="showAddChallengeFormBtn" class="admin-action-btn"><i class="fas fa-plus-circle"></i> Add New Challenge</button>
                    <button id="showAddAnimeFormBtn" class="admin-action-btn"><i class="fas fa-film"></i> Add New Anime to List</button>
                </div>
                <div class="loading-indicator" id="loadingIndicator" style="display: none;">Loading...</div>
            </div> <!-- End of feature-wrapper -->
        </div> <!-- End of main-content-area -->
    </div> <!-- End of page-wrapper -->

    <!-- Modals (same as previous anime.html) -->
    <div id="addChallengeModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" onclick="closeModal('addChallengeModal')">Ã—</span>
            <h3>Add a New Roulette Challenge</h3>
            <form id="addChallengeForm" class="admin-form">
                <div class="form-group"> <label for="challengeTitle">Challenge Title:</label> <input type="text" id="challengeTitle" required> </div>
                <div class="form-group"> <label for="challengeDescription">Description:</label> <textarea id="challengeDescription" rows="3" required></textarea> </div>
                <div class="form-group"> <label for="challengeSuiComment">Sui's Comment (Optional):</label> <textarea id="challengeSuiComment" rows="2"></textarea> </div>
                <div class="form-group"> <label for="challengeCategoryInForm">Category (e.g., Quick, Foodie):</label> <input type="text" id="challengeCategoryInForm"> </div>
                <div class="form-buttons"> <button type="submit">Add Challenge</button> <button type="button" onclick="closeModal('addChallengeModal')">Cancel</button> </div>
            </form>
        </div>
    </div>
    <div id="addAnimeModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" onclick="closeModal('addAnimeModal')">Ã—</span>
            <h3>Add a New Anime Series to Our List</h3>
            <form id="addAnimeForm" class="admin-form">
                <div class="form-group"> <label for="animeTitle">Anime Title (English/Main):</label> <input type="text" id="animeTitle" required> </div>
                <div class="form-group"> <label for="animeGenre">Genre(s) (comma-separated):</label> <input type="text" id="animeGenre" placeholder="e.g., Action, Fantasy"> </div>
                <div class="form-group"> <label for="animeCoverImageURL">Cover Image URL (Optional):</label> <input type="url" id="animeCoverImageURL" placeholder="https://i.imgur.com/....png"> </div>
                <div class="form-buttons"> <button type="submit">Add Anime</button> <button type="button" onclick="closeModal('addAnimeModal')">Cancel</button> </div>
            </form>
        </div>
    </div>
    
    <!-- Right Navigation Bar -->
    <div class="nav-container-right">
        <a href="slimegame.html" class="nav-item slimegame"> <img src="https://i.imgur.com/yFzLbfM.png" alt="Slime Game Icon"> Slime Game </a>
        <a href="anime.html" class="nav-item anime active"> <!-- Active for this page -->
            <img src="https://i.imgur.com/7zP0YwP.png" alt="Anime Journey Icon"> <!-- Your Placeholder Anime Icon -->
            Anime Journey
        </a>
    </div>

    <div class="hearts-container" id="hearts-container"></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7ZJD95q3L0nWY1zVdGsIgKkqmc8DPOvTYoZhpctCWRhkJT0Wh9fCzz0KpAp8qovhHBw/exec"; 
        
        // --- (ALL JavaScript from the previous anime.html response goes here) ---
        // This includes:
        // - fetchedChallenges, fetchedAnimeSeries, currentWheelMode, wheelSegmentsData
        // - canvas, ctx, spinWheelBtn, wheelResultDiv, etc. DOM element selections
        // - Wheel parameters (numSegments, arcSize, centerX, centerY, radius, colors, currentAngle, etc.)
        // - fetchDataForWheel(type)
        // - initializePageData()
        // - loadWheelData()
        // - drawWheel()
        // - spin(), rotateWheel(), easeOutCubic() - or simplified spin, stopRotateWheel()
        // - Mode Switching button event listeners
        // - Modal & Form Logic (openModal, closeModal, form submission handlers for addChallenge and addAnime)
        // - createHearts()
        // - setActiveNav()
        // - window.onload event listener calling initializePageData() and setActiveNav()
        // --- PASTE THE FULL SCRIPT FROM THE PREVIOUS "anime.html" RESPONSE HERE ---

        // For completeness, I am pasting the JavaScript again.
        // In a real project, you might put this in a separate .js file.

        let fetchedChallenges = [];
        let fetchedAnimeSeries = []; 
        let currentWheelMode = 'challenges'; 
        let wheelSegmentsData = []; 
        
        const canvas = document.getElementById('interactiveWheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinWheelBtn = document.getElementById('spinWheelBtn');
        const wheelResultDiv = document.getElementById('wheelResult');
        const challengeDescriptionDisplay = document.getElementById('challengeDescriptionDisplay');
        const suiCommentDisplay = document.getElementById('suiCommentDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const spinBtnText = document.getElementById('spinBtnText');

        let numSegments = 0;
        let arcSize = 0;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = canvas.width / 2 - 10; // Keep some padding
        const colors = ["#FFC0CB", "#ADD8E6", "#90EE90", "#FFD700", "#FFA07A", "#DDA0DD", "#87CEFA", "#F08080", "#FFB6C1", "#AFEEEE", "#E6E6FA", "#FFDEAD", "#dda0dd", "#b0e0e6", "#ff7f50", "#deb887"];
        let currentAngle = Math.PI / 2; // Start with pointer effectively at the top
        let spinAngleStart = 0;
        let spinTime = 0;
        let spinTimeTotal = 0;
        let isSpinning = false;
        let animationFrameId = null;

        async function fetchDataForWheel(type) {
            let action = '';
            if (type === 'challenges') action = 'getAnimeChallenges'; 
            else if (type === 'series') action = 'getAnimeListForWheel'; 
            else return [];

            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (spinWheelBtn) spinWheelBtn.disabled = true;

            try {
                const response = await fetch(`${SCRIPT_URL}?action=${action}&cb=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Network error for ${type}: ${response.statusText}`);
                const data = await response.json();
                if (data.status === "error") throw new Error(`Script error for ${type}: ${data.message}`);
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                // spinWheelBtn will be enabled by loadWheelData if data is present
                return data;
            } catch (error) {
                console.error(`Failed to load ${type}:`, error);
                if (loadingIndicator) loadingIndicator.textContent = `Error loading ${type}. Try refreshing.`;
                if (spinWheelBtn) spinWheelBtn.disabled = true; 
                return [];
            }
        }

        async function initializePageData() {
            if(loadingIndicator) loadingIndicator.textContent = 'Loading Challenges...';
            fetchedChallenges = await fetchDataForWheel('challenges');
            if(loadingIndicator) loadingIndicator.textContent = 'Loading Anime Series...';
            fetchedAnimeSeries = await fetchDataForWheel('series'); 
            if(loadingIndicator) loadingIndicator.style.display = 'none';
            
            loadWheelData(); 
        }

        function loadWheelData() {
            if (challengeDescriptionDisplay) challengeDescriptionDisplay.style.display = 'none';
            if (suiCommentDisplay) suiCommentDisplay.style.display = 'none';

            if (currentWheelMode === 'challenges') {
                wheelSegmentsData = fetchedChallenges.map(c => ({ title: c.ChallengeTitle, fullData: c }));
                if(spinBtnText) spinBtnText.textContent = "Challenge";
            } else { 
                wheelSegmentsData = fetchedAnimeSeries.map(a => ({ title: a.Title, fullData: a })); 
                if(spinBtnText) spinBtnText.textContent = "Anime Series";
            }

            if (!wheelSegmentsData || wheelSegmentsData.length === 0) {
                if (wheelResultDiv) wheelResultDiv.textContent = `No ${currentWheelMode} loaded! Add some.`;
                if(ctx) { 
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#777'; ctx.font = '14px Poppins';
                    ctx.fillText(`No ${currentWheelMode} for roulette!`, centerX, centerY);
                }
                numSegments = 0;
                if (spinWheelBtn) spinWheelBtn.disabled = true;
                return;
            }
            
            numSegments = wheelSegmentsData.length;
            arcSize = (2 * Math.PI) / numSegments;
            if (spinWheelBtn) spinWheelBtn.disabled = false;
            currentAngle =  Math.PI / 2 - (arcSize/2); // Adjust so pointer aims at middle of a segment initially
            drawWheel();
        }

        function drawWheel() {
            if (!ctx) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.strokeStyle = '#666'; 
            ctx.lineWidth = 1;
            ctx.font = 'bold 10px Poppins';
            
            for(let i = 0; i < numSegments; i++) {
                const angle = currentAngle + i * arcSize;
                ctx.fillStyle = colors[i % colors.length];

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, angle, angle + arcSize, false);
                ctx.lineTo(centerX, centerY);
                ctx.fill();
                ctx.stroke();

                ctx.save();
                ctx.fillStyle = var(--dark); 
                ctx.translate(centerX + Math.cos(angle + arcSize / 2) * radius * 0.65, 
                              centerY + Math.sin(angle + arcSize / 2) * radius * 0.65);
                ctx.rotate(angle + arcSize / 2 + Math.PI / 2); 
                
                const text = wheelSegmentsData[i].title;
                let clippedText = text;
                const maxTextWidth = radius * 0.6; // Max width for text within segment
                
                if (ctx.measureText(text).width > maxTextWidth) {
                    let a = 0; let b = text.length; let t = "";
                    while(a <= b) {
                      let m = Math.floor((a+b)/2);
                      if (m === 0) { b = -1; break; } // Prevent infinite loop on very short allowance
                      if(ctx.measureText(text.substring(0,m)).width <= maxTextWidth) { t = text.substring(0,m); a = m + 1;}
                      else { b = m - 1; }
                    }
                    clippedText = t + (t.length < text.length ? ".." : "");
                }
                ctx.textAlign = 'center'; 
                ctx.textBaseline = 'middle';
                ctx.fillText(clippedText, 0, 0);
                ctx.restore();
            }
        }

        function spin() {
            if (isSpinning || numSegments === 0) return;
            isSpinning = true;
            if (spinWheelBtn) spinWheelBtn.disabled = true;
            if (wheelResultDiv) wheelResultDiv.textContent = "Spinning...";
            if (challengeDescriptionDisplay) challengeDescriptionDisplay.style.display = 'none';
            if (suiCommentDisplay) suiCommentDisplay.style.display = 'none';

            spinAngleStart = Math.random() * 10 + 15; // Base revolutions
            spinTime = 0;
            // Adjust total spin time, more segments might need slightly longer to feel right
            spinTimeTotal = Math.random() * 2000 + (numSegments > 6 ? 4500 : 3500); 
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            rotateWheel();
        }

        function rotateWheel() {
            spinTime += 16; 
            if(spinTime >= spinTimeTotal) {
                stopRotateWheel();
                return;
            }
            // Ease-out function: starts fast, slows down
            // (1 - (1-x)^N) where N is power (e.g., 3 for cubic, 4 for quartic)
            // Or: (1 - x)^N for deceleration amount directly
            let t = spinTime / spinTimeTotal;
            let spinFactor = Math.pow(1 - t, 3); // Cubic ease-out for deceleration speed

            currentAngle += (spinAngleStart * spinFactor * Math.PI * 2 / 60 ); // 60 is arbitrary speed factor
            currentAngle %= (2 * Math.PI); 
            drawWheel();
            animationFrameId = requestAnimationFrame(rotateWheel);
        }

        function stopRotateWheel() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            isSpinning = false;
            if (spinWheelBtn) spinWheelBtn.disabled = (numSegments === 0);
            
            // Pointer is at 3 o'clock (0 radians on canvas if not rotated)
            // currentAngle is the angle of the start of segment 0 from the positive x-axis
            const pointerFixedAngle = 0; // Pointer at 3 o'clock
            let finalAngle = currentAngle % (2 * Math.PI);
            if (finalAngle < 0) finalAngle += (2 * Math.PI);

            // Which segment is under the pointer (0 radians)?
            // We need to find i such that: finalAngle + i * arcSize <= 0 < finalAngle + (i+1) * arcSize (all modulo 2PI)
            // Or, easier: (2*PI - finalAngle) / arcSize gives how many full segments have passed the pointer
            let effectiveAngle = (2 * Math.PI) - finalAngle + pointerFixedAngle;
            effectiveAngle = (effectiveAngle % (2 * Math.PI) + (2 * Math.PI)) % (2 * Math.PI); // Normalize
            
            const selectedIndex = Math.floor(effectiveAngle / arcSize) % numSegments; // Ensure index is within bounds
            
            const selectedItem = wheelSegmentsData[selectedIndex];

            if (selectedItem) {
                if(wheelResultDiv) wheelResultDiv.textContent = selectedItem.title;
                if (currentWheelMode === 'challenges' && selectedItem.fullData) {
                    if(challengeDescriptionDisplay) {
                        challengeDescriptionDisplay.innerHTML = selectedItem.fullData.ChallengeDescription ? selectedItem.fullData.ChallengeDescription.replace(/\n/g, '<br>') : '';
                        challengeDescriptionDisplay.style.display = selectedItem.fullData.ChallengeDescription ? 'block' : 'none';
                    }
                    if(suiCommentDisplay) {
                        suiCommentDisplay.innerHTML = selectedItem.fullData.SuiComment ? `<strong>Sui says:</strong> "${selectedItem.fullData.SuiComment.replace(/\n/g, '<br>')}"` : '';
                        suiCommentDisplay.style.display = selectedItem.fullData.SuiComment ? 'block' : 'none';
                    }
                }
            } else {
                if(wheelResultDiv) wheelResultDiv.textContent = "Error! Spin Again?";
                console.error("Could not determine selected item. Index:", selectedIndex, "Angle:", currentAngle, "Data:", wheelSegmentsData);
            }
        }
        if(spinWheelBtn) spinWheelBtn.addEventListener('click', spin);

        const challengeModeBtn = document.getElementById('challengeModeBtn');
        const seriesModeBtn = document.getElementById('seriesModeBtn');

        if(challengeModeBtn) challengeModeBtn.addEventListener('click', () => {
            if (currentWheelMode !== 'challenges') {
                currentWheelMode = 'challenges';
                challengeModeBtn.classList.add('active');
                if(seriesModeBtn) seriesModeBtn.classList.remove('active');
                if(wheelResultDiv) wheelResultDiv.textContent = 'Spin for a Challenge!';
                loadWheelData(); 
            }
        });
        if(seriesModeBtn) seriesModeBtn.addEventListener('click', () => {
            if (currentWheelMode !== 'series') {
                currentWheelMode = 'series';
                seriesModeBtn.classList.add('active');
                if(challengeModeBtn) challengeModeBtn.classList.remove('active');
                if(wheelResultDiv) wheelResultDiv.textContent = 'Spin for an Anime Series!';
                loadWheelData(); 
            }
        });

        // Modal & Form Logic
        const showAddChallengeFormBtn = document.getElementById('showAddChallengeFormBtn');
        const addChallengeModal = document.getElementById('addChallengeModal');
        const addChallengeForm = document.getElementById('addChallengeForm');
        const showAddAnimeFormBtn = document.getElementById('showAddAnimeFormBtn');
        const addAnimeModal = document.getElementById('addAnimeModal');
        const addAnimeForm = document.getElementById('addAnimeForm');

        function openModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.style.display = 'flex';}
        function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.style.display = 'none'; const form = modal.querySelector('form'); if (form) form.reset(); } }
        if (showAddChallengeFormBtn) showAddChallengeFormBtn.addEventListener('click', () => openModal('addChallengeModal'));
        if (showAddAnimeFormBtn) showAddAnimeFormBtn.addEventListener('click', () => openModal('addAnimeModal'));
        window.onclick = function(event) { if (event.target.classList.contains('modal')) { closeModal(event.target.id); } }

        if (addChallengeForm) {
            addChallengeForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]'); const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = 'Adding...'; submitBtn.disabled = true;
                const params = new URLSearchParams({
                    action: "addChallenge", title: document.getElementById('challengeTitle').value,
                    description: document.getElementById('challengeDescription').value,
                    suiComment: document.getElementById('challengeSuiComment').value || "",
                    category: document.getElementById('challengeCategoryInForm').value || ""
                });
                try {
                    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await response.json();
                    if (result.status === "success") {
                        alert("New challenge added!"); closeModal('addChallengeModal');
                        fetchedChallenges = await fetchDataForWheel('challenges'); 
                        if(currentWheelMode === 'challenges') loadWheelData(); 
                    } else { throw new Error(result.message || "Failed to add."); }
                } catch (error) { console.error("Error adding challenge:", error); alert(`Error: ${error.message}`);
                } finally { submitBtn.innerHTML = originalBtnText; submitBtn.disabled = false; }
            });
        }

        if (addAnimeForm) {
            addAnimeForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]'); const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = 'Adding...'; submitBtn.disabled = true;
                const params = new URLSearchParams({
                    action: "addAnimeToList", title: document.getElementById('animeTitle').value,
                    genre: document.getElementById('animeGenre').value || "", 
                    coverImageURL: document.getElementById('animeCoverImageURL').value || ""
                });
                try {
                    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`); const result = await response.json();
                    if (result.status === "success") {
                        alert("New anime added!"); closeModal('addAnimeModal');
                        fetchedAnimeSeries = await fetchDataForWheel('series'); 
                        if(currentWheelMode === 'series') loadWheelData(); 
                    } else { throw new Error(result.message || "Failed to add."); }
                } catch (error) { console.error("Error adding anime:", error); alert(`Error: ${error.message}`);
                } finally { submitBtn.innerHTML = originalBtnText; submitBtn.disabled = false; }
            });
        }
        
        function createHearts() { 
            const heartsContainer = document.getElementById('hearts-container');
            if (!heartsContainer) return; 
            if (heartsContainer.children.length > 30) return; // Limit total hearts
            const heart = document.createElement('div'); heart.className = 'heart'; 
            heart.innerHTML = ['ðŸ’œ','ðŸ’–','ðŸ’•','ðŸ’ž','ðŸ’“','ðŸ’—'][Math.floor(Math.random()*6)];
            heart.style.left = Math.random()*100+'vw'; 
            heart.style.animationDuration = 8 + Math.random()*7+'s';
            heart.style.animationDelay = Math.random()*5+'s'; 
            heart.style.fontSize = (18+Math.random()*22)+'px';
            heartsContainer.appendChild(heart);
            // Remove heart after animation + a little buffer
            setTimeout(()=>heart.remove(), (parseFloat(heart.style.animationDuration.replace('s','')) + parseFloat(heart.style.animationDelay.replace('s',''))) * 1000 + 500 );
        }
        
        function setActiveNav() { 
            const leftNavItems = document.querySelectorAll('.nav-container-left .nav-item');
            const rightNavItems = document.querySelectorAll('.nav-container-right .nav-item');
            const allNavItems = [...leftNavItems, ...rightNavItems];
            let path = window.location.pathname.split('/').pop();
            if (path === "" || path === "index.html") { path = "index.html"; }
            
            allNavItems.forEach(item => {
                item.classList.remove('active');
                // Check if the item's href matches the current page's filename
                if (item.getAttribute('href') === path) {
                    // If it's the anime.html page, ensure the anime link in the right nav is active
                    if (path === "anime.html" && item.closest('.nav-container-right') && item.classList.contains('anime')) {
                         item.classList.add('active');
                    } else if (path !== "anime.html") { // For other pages, default behavior
                        item.classList.add('active');
                    }
                }
            });
             // Explicitly set anime link active if on anime.html (covers cases where initial logic might miss)
            if (path === "anime.html") {
                const animeLinkRight = document.querySelector('.nav-container-right .nav-item.anime');
                if (animeLinkRight) animeLinkRight.classList.add('active');
            }
        }

        window.onload = function() {
            for (let i = 0; i < 10; i++) { setTimeout(()=>createHearts(), i * 500); }
            setInterval(createHearts, 7000); 
            setActiveNav(); 
            initializePageData(); 
        };
    </script>
</body>
</html>