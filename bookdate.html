    <script>
        // SCRIPT_URL should be your deployed Google Apps Script Web App URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyAi2kuzS-fAYPGnEm3jcYprPNr1neJBD4qRhewUKYCoR93bW6YOhUTj-icqoKX8zcuBg/exec";
        
        // Global variable to store fetched date ideas, categorized
        let fetchedDateIdeas = {
            virtual: [], creative: [], gaming: [], spicy: []
        };
        let allFetchedIdeas = []; // Flat array of all ideas for "Surprise Me"

        let selectedMood = '', currentIdea = '', currentDescription = '', currentSpicyDesc = '';
        
        // Function to fetch date ideas from Google Sheet
        async function loadDateIdeas() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const generateDateBtn = document.getElementById('generateDateBtn');
            
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (generateDateBtn) generateDateBtn.disabled = true;

            try {
                // Add a cache-busting parameter to the URL
                const response = await fetch(`${SCRIPT_URL}?action=getDateIdeas&cb=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                if (data.status === "error") { // Check for errors reported by Apps Script
                    throw new Error(`Error from Google Script: ${data.message}`);
                }
                
                // Clear previous ideas
                fetchedDateIdeas = { virtual: [], creative: [], gaming: [], spicy: [] };
                allFetchedIdeas = [];

                // Assuming 'data' is the array of idea objects directly from Apps Script
                data.forEach(item => {
                    const ideaObject = {
                        // Make sure these property names match what your Apps Script's getDateIdeasFromSheet returns
                        idea: item.ideaTitle || item.idea, // Use 'ideaTitle' if present, fallback to 'idea'
                        description: item.description,
                        spicyDesc: item.spicyDesc || "" 
                    };
                    const category = item.category ? item.category.toLowerCase() : null;

                    if (category && fetchedDateIdeas[category]) {
                        fetchedDateIdeas[category].push(ideaObject);
                    }
                    allFetchedIdeas.push(ideaObject); // For "Surprise Me"
                });

                console.log("Date ideas loaded and categorized:", fetchedDateIdeas);
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (generateDateBtn) generateDateBtn.disabled = false;

            } catch (error) {
                console.error('Failed to load date ideas:', error);
                if (loadingIndicator) loadingIndicator.textContent = 'Error loading ideas. Please try refreshing.';
                // Optionally, you could load hardcoded default ideas here as a fallback
                // initializeHardcodedFallbackIdeas(); 
                // if (generateDateBtn) generateDateBtn.disabled = false; // Enable button if using fallback
            }
        }
        
        function selectMood(button, mood) { 
            document.querySelectorAll('.mood-btn').forEach(btn=>btn.classList.remove('active')); 
            button.classList.add('active'); 
            selectedMood=mood;
        }
        
        function generateDate() {
            let ideasAvailable = false;
            for (const categoryKey in fetchedDateIdeas) {
                if (fetchedDateIdeas[categoryKey] && fetchedDateIdeas[categoryKey].length > 0) {
                    ideasAvailable = true;
                    break;
                }
            }
            if (!ideasAvailable && allFetchedIdeas.length === 0) { // Check allFetchedIdeas too for surprise
                 alert("Date ideas are still loading or failed to load. Please wait or try again.");
                return;
            }

            if (!selectedMood && selectedMood !== 'surprise') {
                alert("Please select a mood first!");
                return;
            }
            
            let ideasPool;
            if (selectedMood === 'surprise') {
                if (allFetchedIdeas.length === 0) {
                    alert("No ideas available for 'Surprise Me' yet!"); return;
                }
                ideasPool = allFetchedIdeas;
            } else {
                if (!fetchedDateIdeas[selectedMood] || fetchedDateIdeas[selectedMood].length === 0) {
                    alert(`No ideas available for the '${selectedMood}' mood yet! Try 'Surprise Me' or suggest one.`); return;
                }
                ideasPool = fetchedDateIdeas[selectedMood];
            }
            
            if (!ideasPool || ideasPool.length === 0) { 
                 alert("No ideas found for the selected criteria. This shouldn't happen if the previous checks passed!");
                 return;
            }

            const randomIdea = ideasPool[Math.floor(Math.random() * ideasPool.length)];
            
            document.getElementById('dateIdea').textContent = randomIdea.idea; 
            document.getElementById('dateDescription').textContent = randomIdea.description;
            
            const spicyToggleContainer = document.getElementById('spicyToggleContainer');
            if (randomIdea.spicyDesc) { 
                document.getElementById('spicyDescription').textContent = randomIdea.spicyDesc; 
                spicyToggleContainer.style.display = 'flex'; 
                document.getElementById('spicyToggle').checked = false; 
                document.getElementById('spicyDescription').style.display = 'none';
            } else { 
                spicyToggleContainer.style.display = 'none'; 
                document.getElementById('spicyDescription').style.display = 'none'; 
            }
            
            document.getElementById('result').style.display = 'block'; 
            document.getElementById('bookingForm').style.display = 'none'; 
            document.getElementById('confirmation').style.display = 'none';
            document.getElementById('suggestionForm').style.display = 'none'; 
            document.getElementById('suggestionConfirmation').style.display = 'none';
            
            currentIdea = randomIdea.idea; 
            currentDescription = randomIdea.description; 
            currentSpicyDesc = randomIdea.spicyDesc || '';
            createHearts();
        }
        
        document.getElementById('spicyToggle').addEventListener('change', function() { 
            document.getElementById('spicyDescription').style.display = this.checked ? 'block' : 'none';
        });
        
        function showBookingForm() { 
            document.getElementById('bookingForm').style.display = 'block'; 
            document.getElementById('date').min = new Date().toISOString().split("T")[0];
            document.getElementById('bookingForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showSuggestionForm() { 
            document.getElementById('suggestionForm').style.display = 'block'; 
            document.getElementById('result').style.display = 'none';
            document.getElementById('bookingForm').style.display = 'none'; 
            document.getElementById('confirmation').style.display = 'none';
            document.getElementById('suggestionConfirmation').style.display = 'none'; 
            document.getElementById('suggestionForm').scrollIntoView({ behavior: 'smooth' });
        }
        function hideSuggestionForm() { 
            document.getElementById('suggestionForm').style.display = 'none'; 
            document.getElementById('customDateForm').reset();
        }
        
        async function submitBooking(event) { 
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirming...';

            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const duration = document.getElementById('duration').value;
            const platform = document.getElementById('platform').value;
            const email = document.getElementById('email').value;
            const prep = document.getElementById('prep').value || "None needed";
            const showSpicy = document.getElementById('spicyToggle').checked;
            
            const startDateTime = new Date(`${date}T${time}`);
            const formattedDate = startDateTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const formattedTime = startDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('confirmedIdea').textContent=currentIdea; 
            document.getElementById('confirmedDate').textContent=formattedDate; 
            document.getElementById('confirmedTime').textContent=formattedTime;
            document.getElementById('confirmedDuration').textContent=duration; 
            document.getElementById('confirmedPlatform').textContent=platform; 
            document.getElementById('confirmedEmail').textContent=email; 
            document.getElementById('confirmedPrep').textContent=prep;

            const sheetData = {
                action: "scheduleDate", 
                ideaTitle: currentIdea, 
                scheduledDate: date, 
                scheduledTime: time, 
                duration: duration, 
                platform: platform,
                userEmail: email, 
                prepNotes: prep, 
                showedSpicy: showSpicy.toString() // Send as string "true" or "false"
            };

            try {
                const response = await fetch(`${SCRIPT_URL}?${new URLSearchParams(sheetData).toString()}`);
                const result = await response.json();

                if (result.status !== "success") { 
                    throw new Error(result.message || 'Failed to log scheduled date to sheet.'); 
                }
                console.log('Date successfully logged to sheet.');

                document.getElementById('bookingForm').style.display = 'none'; 
                document.getElementById('confirmation').style.display = 'block';
                document.getElementById('confirmation').scrollIntoView({ behavior: 'smooth' });
                for (let i=0; i<25; i++) { setTimeout(()=>createHearts(), i*150); }
            } catch (error) {
                console.error('Error submitting booking:', error);
                alert(`There was an error scheduling your date: ${error.message}. Please try again.`);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }
        
        async function submitSuggestion(event) { 
            event.preventDefault();
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            const title = document.getElementById('suggestionTitle').value;
            const description = document.getElementById('suggestionDescription').value;
            const category = document.getElementById('suggestionCategory').value;
            const spicy = document.getElementById('suggestionSpicy').value;

            const sheetData = {
                action: "addSuggestion", 
                title: title, 
                description: description,
                category: category, 
                spicy: spicy || "", 
                submitterInfo: "Website User" // Or any other identifier
            };
            
            try {
                const response = await fetch(`${SCRIPT_URL}?${new URLSearchParams(sheetData).toString()}`);
                const result = await response.json();

                if (result.status === "success") {
                    console.log('Suggestion sent to sheet!'); 
                    document.getElementById('suggestionForm').style.display = 'none'; 
                    document.getElementById('suggestionConfirmation').style.display = 'block';
                    document.getElementById('suggestionConfirmation').scrollIntoView({ behavior: 'smooth' }); 
                    document.getElementById('customDateForm').reset();
                    for (let i=0; i<15; i++) { setTimeout(()=>createHearts(), i*150); }
                    // Optionally reload ideas if you want the new suggestion (if auto-approved) to appear
                    // await loadDateIdeas(); 
                } else { 
                    throw new Error(result.message || 'Failed to send suggestion to sheet'); 
                }
            } catch (error) {
                console.error('Error submitting suggestion:', error);
                alert(`There was an error submitting your suggestion: ${error.message}. Please try again.`);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }
        
        function resetForm() { 
            document.getElementById('dateForm').reset(); 
            document.getElementById('customDateForm').reset();
            document.getElementById('result').style.display = 'none'; 
            document.getElementById('confirmation').style.display = 'none';
            document.getElementById('suggestionForm').style.display = 'none'; 
            document.getElementById('suggestionConfirmation').style.display = 'none';
            document.querySelectorAll('.mood-btn').forEach(btn=>btn.classList.remove('active')); 
            selectedMood = '';
        }
        
        function createHearts() { 
            const heart = document.createElement('div'); 
            heart.className = 'heart'; 
            heart.innerHTML = ['â¤ï¸','ðŸ’–','ðŸ’˜','ðŸ’','ðŸ’“','ðŸ’—'][Math.floor(Math.random()*6)];
            heart.style.left = Math.random()*100+'vw'; 
            heart.style.animationDuration = 5+Math.random()*5+'s';
            heart.style.animationDelay = Math.random()*2+'s'; 
            heart.style.fontSize = (20+Math.random()*30)+'px';
            const heartsContainer = document.getElementById('hearts-container');
            if (heartsContainer) { // Ensure container exists
                heartsContainer.appendChild(heart);
                setTimeout(()=>heart.remove(), 8000);
            }
        }
        
        function setActiveNav() { 
            const leftNavItems = document.querySelectorAll('.nav-container-left .nav-item');
            const rightNavItems = document.querySelectorAll('.nav-container-right .nav-item');
            const allNavItems = [...leftNavItems, ...rightNavItems];
            let path = window.location.pathname.split('/').pop();
            if (path === "" || path === "index.html") { path = "index.html"; }
            allNavItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('href') === path) { item.classList.add('active'); }
            });
        }

        window.onload = function() {
            const dateInput = document.getElementById('date');
            if (dateInput) { // Ensure date input exists
                 dateInput.min = new Date().toISOString().split('T')[0];
            }
            for (let i = 0; i < 15; i++) { setTimeout(()=>createHearts(), i * 300); }
            setActiveNav(); 
            loadDateIdeas(); // Load ideas from Google Sheet on page load
        };
    </script>
</body>
</html>